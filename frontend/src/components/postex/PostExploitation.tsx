import { useEffect, useState, useCallback } from 'react'
import { useSessionStore } from '../../store/sessionStore'
import { api } from '../../services/api'
import { Session, Credential, CredentialCreate, PostModule, ProcessInfo, FileInfo, SystemInfo, Module } from '../../types'
import {
  Shield,
  FolderOpen,
  Cpu,
  Key,
  Search,
  RefreshCw,
  ChevronRight,
  Play,
  Trash2,
  Plus,
  X,
  ArrowUp,
  Download,
  Camera,
  Crosshair,
  Loader2,
  Terminal,
  Hash,
  Copy,
  File,
  Folder,
  Monitor,
  AlertTriangle,
} from 'lucide-react'

type TabType = 'info' | 'processes' | 'files' | 'credentials' | 'modules'

export default function PostExploitation() {
  const { sessions, fetchSessions } = useSessionStore()
  const [selectedSession, setSelectedSession] = useState<Session | null>(null)
  const [activeTab, setActiveTab] = useState<TabType>('info')
  const [isLoading, setIsLoading] = useState(false)

  // System info state
  const [sysinfo, setSysinfo] = useState<SystemInfo | null>(null)
  const [uid, setUid] = useState<string>('')
  const [privs, setPrivs] = useState<string[]>([])

  // Process state
  const [processes, setProcesses] = useState<ProcessInfo[]>([])
  const [processSearch, setProcessSearch] = useState('')

  // File browser state
  const [currentPath, setCurrentPath] = useState('')
  const [files, setFiles] = useState<FileInfo[]>([])
  const [pathHistory, setPathHistory] = useState<string[]>([])

  // Credentials state
  const [credentials, setCredentials] = useState<Credential[]>([])
  const [showAddCred, setShowAddCred] = useState(false)
  const [credForm, setCredForm] = useState<CredentialCreate>({
    username: '',
    password: '',
    hash: '',
    host: '',
    service: '',
    notes: '',
    source: 'manual',
  })

  // Modules state
  const [postModules, setPostModules] = useState<PostModule[]>([])
  const [moduleSearch, setModuleSearch] = useState('')
  const [modulePlatform, setModulePlatform] = useState('')
  const [platforms, setPlatforms] = useState<string[]>([])
  const [selectedModule, setSelectedModule] = useState<Module | null>(null)
  const [moduleOptions, setModuleOptions] = useState<Record<string, string>>({})

  useEffect(() => {
    fetchSessions()
  }, [fetchSessions])

  // Filter only meterpreter sessions
  const meterpreterSessions = sessions.filter((s) => s.type === 'meterpreter')

  const loadSystemInfo = useCallback(async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const [sysinfoRes, uidRes, privsRes] = await Promise.all([
        api.getSysinfo(selectedSession.id),
        api.getUid(selectedSession.id),
        api.getPrivs(selectedSession.id),
      ])
      setSysinfo(sysinfoRes)
      setUid(uidRes.user)
      setPrivs(privsRes.privileges)
    } catch (e) {
      console.error('Failed to load system info:', e)
    } finally {
      setIsLoading(false)
    }
  }, [selectedSession])

  const loadProcesses = useCallback(async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const data = await api.listProcesses(selectedSession.id)
      setProcesses(data.processes)
    } catch (e) {
      console.error('Failed to load processes:', e)
    } finally {
      setIsLoading(false)
    }
  }, [selectedSession])

  const loadFiles = useCallback(async (path: string = '.') => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      if (!path || path === '.') {
        const pwdRes = await api.getPwd(selectedSession.id)
        path = pwdRes.path
      }
      const data = await api.listFiles(selectedSession.id, path)
      setFiles(data.files)
      setCurrentPath(data.path || path)
    } catch (e) {
      console.error('Failed to load files:', e)
    } finally {
      setIsLoading(false)
    }
  }, [selectedSession])

  const loadCredentials = useCallback(async () => {
    setIsLoading(true)
    try {
      const data = await api.getCredentials()
      setCredentials(data.credentials)
    } catch (e) {
      console.error('Failed to load credentials:', e)
    } finally {
      setIsLoading(false)
    }
  }, [])

  const loadModules = useCallback(async () => {
    setIsLoading(true)
    try {
      const data = await api.getPostModules({
        platform: modulePlatform || undefined,
        search: moduleSearch || undefined,
      })
      setPostModules(data.modules)
      setPlatforms(data.platforms)
    } catch (e) {
      console.error('Failed to load modules:', e)
    } finally {
      setIsLoading(false)
    }
  }, [modulePlatform, moduleSearch])

  useEffect(() => {
    if (selectedSession) {
      if (activeTab === 'info') loadSystemInfo()
      else if (activeTab === 'processes') loadProcesses()
      else if (activeTab === 'files') loadFiles()
    }
    if (activeTab === 'credentials') loadCredentials()
    if (activeTab === 'modules') loadModules()
  }, [selectedSession, activeTab, loadSystemInfo, loadProcesses, loadFiles, loadCredentials, loadModules])

  const handleSessionSelect = (session: Session) => {
    setSelectedSession(session)
    setActiveTab('info')
    setSysinfo(null)
    setUid('')
    setPrivs([])
    setProcesses([])
    setFiles([])
    setCurrentPath('')
  }

  const handleKillProcess = async (pid: number) => {
    if (!selectedSession || !confirm(`Kill process ${pid}?`)) return
    try {
      await api.killProcess(selectedSession.id, pid)
      loadProcesses()
    } catch (e) {
      console.error('Failed to kill process:', e)
      alert('Failed to kill process')
    }
  }

  const handleMigrate = async (pid: number) => {
    if (!selectedSession || !confirm(`Migrate to process ${pid}?`)) return
    try {
      const result = await api.migrateProcess(selectedSession.id, pid)
      alert(result.message)
      loadSystemInfo()
    } catch (e) {
      console.error('Failed to migrate:', e)
      alert('Failed to migrate')
    }
  }

  const handleNavigate = (name: string, isDir: boolean) => {
    if (!isDir) return
    const newPath = currentPath.endsWith('/') || currentPath.endsWith('\\')
      ? `${currentPath}${name}`
      : `${currentPath}/${name}`
    setPathHistory([...pathHistory, currentPath])
    loadFiles(newPath)
  }

  const handleGoBack = () => {
    if (pathHistory.length === 0) return
    const prevPath = pathHistory[pathHistory.length - 1]
    setPathHistory(pathHistory.slice(0, -1))
    loadFiles(prevPath)
  }

  const handleDownloadFile = async (filename: string) => {
    if (!selectedSession) return
    try {
      const fullPath = currentPath.endsWith('/') || currentPath.endsWith('\\')
        ? `${currentPath}${filename}`
        : `${currentPath}/${filename}`
      const data = await api.downloadFile(selectedSession.id, fullPath)
      // Decode base64 and download
      const blob = new Blob([atob(data.content)], { type: 'application/octet-stream' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = data.filename
      a.click()
      URL.revokeObjectURL(url)
    } catch (e) {
      console.error('Failed to download:', e)
      alert('Failed to download file')
    }
  }

  const handleAddCredential = async (e: React.FormEvent) => {
    e.preventDefault()
    try {
      await api.addCredential(credForm)
      setShowAddCred(false)
      setCredForm({ username: '', password: '', hash: '', host: '', service: '', notes: '', source: 'manual' })
      loadCredentials()
    } catch (e) {
      console.error('Failed to add credential:', e)
      alert('Failed to add credential')
    }
  }

  const handleDeleteCredential = async (id: string) => {
    if (!confirm('Delete this credential?')) return
    try {
      await api.deleteCredential(id)
      loadCredentials()
    } catch (e) {
      console.error('Failed to delete credential:', e)
    }
  }

  const handleHashdump = async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const result = await api.hashdump(selectedSession.id)
      // Add hashes to credentials
      for (const hash of result.hashes) {
        await api.addCredential({
          username: hash.username,
          hash: hash.ntlm_hash,
          hash_type: 'NTLM',
          host: selectedSession.session_host,
          source: 'hashdump',
        })
      }
      alert(`Dumped ${result.count} hashes`)
      loadCredentials()
    } catch (e) {
      console.error('Hashdump failed:', e)
      alert('Hashdump failed - may require SYSTEM privileges')
    } finally {
      setIsLoading(false)
    }
  }

  const handleGetSystem = async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const result = await api.getSystem(selectedSession.id)
      alert(result.message)
      if (result.success) loadSystemInfo()
    } catch (e) {
      console.error('GetSystem failed:', e)
      alert('GetSystem failed')
    } finally {
      setIsLoading(false)
    }
  }

  const handleSuggestExploits = async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const result = await api.suggestExploits(selectedSession.id)
      alert(`Local exploit suggester started (Job ID: ${result.job_id})`)
    } catch (e) {
      console.error('Suggest exploits failed:', e)
      alert('Failed to run local exploit suggester')
    } finally {
      setIsLoading(false)
    }
  }

  const handleTakeScreenshot = async () => {
    if (!selectedSession) return
    setIsLoading(true)
    try {
      const result = await api.takeScreenshot(selectedSession.id)
      alert(result.message)
    } catch (e) {
      console.error('Screenshot failed:', e)
      alert('Screenshot failed')
    } finally {
      setIsLoading(false)
    }
  }

  const handleLoadModuleInfo = async (mod: PostModule) => {
    try {
      const info = await api.getPostModuleInfo(mod.name)
      setSelectedModule(info)
      // Set default options
      const defaults: Record<string, string> = {}
      if (info.options) {
        for (const [key, opt] of Object.entries(info.options)) {
          if (opt.default !== null && opt.default !== undefined) {
            defaults[key] = String(opt.default)
          }
        }
      }
      if (selectedSession) {
        defaults['SESSION'] = String(selectedSession.id)
      }
      setModuleOptions(defaults)
    } catch (e) {
      console.error('Failed to load module info:', e)
    }
  }

  const handleRunModule = async () => {
    if (!selectedModule) return
    setIsLoading(true)
    try {
      const result = await api.runPostModule(selectedModule.fullname?.replace('post/', '') || selectedModule.name, moduleOptions)
      alert(`Module launched (Job ID: ${result.job_id})`)
    } catch (e) {
      console.error('Failed to run module:', e)
      alert('Failed to run module')
    } finally {
      setIsLoading(false)
    }
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
  }

  const filteredProcesses = processes.filter((p) =>
    !processSearch || p.name.toLowerCase().includes(processSearch.toLowerCase()) ||
    p.user.toLowerCase().includes(processSearch.toLowerCase()) ||
    String(p.pid).includes(processSearch)
  )

  const tabs = [
    { id: 'info' as TabType, label: 'System Info', icon: Monitor },
    { id: 'processes' as TabType, label: 'Processes', icon: Cpu },
    { id: 'files' as TabType, label: 'Files', icon: FolderOpen },
    { id: 'credentials' as TabType, label: 'Credentials', icon: Key },
    { id: 'modules' as TabType, label: 'Post Modules', icon: Terminal },
  ]

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-white">Post-Exploitation</h1>
          <p className="text-gray-400 mt-1">Manage sessions and run post-exploitation modules</p>
        </div>
        <button
          onClick={() => fetchSessions()}
          className="btn btn-secondary flex items-center gap-2"
        >
          <RefreshCw className="w-4 h-4" />
          Refresh Sessions
        </button>
      </div>

      {/* Session Selector */}
      <div className="bg-msf-card border border-msf-border rounded-lg p-4">
        <h3 className="text-sm font-medium text-white mb-3">Select Meterpreter Session</h3>
        {meterpreterSessions.length === 0 ? (
          <div className="text-center py-8 text-gray-400">
            <Shield className="w-12 h-12 mx-auto mb-2 opacity-50" />
            <p>No meterpreter sessions available</p>
            <p className="text-sm">Get a session first to use post-exploitation features</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {meterpreterSessions.map((session) => (
              <button
                key={session.id}
                onClick={() => handleSessionSelect(session)}
                className={`p-3 rounded-lg border text-left transition-colors ${
                  selectedSession?.id === session.id
                    ? 'bg-msf-accent/20 border-msf-accent'
                    : 'bg-msf-darker border-msf-border hover:border-msf-accent/50'
                }`}
              >
                <div className="flex items-center gap-2">
                  <Terminal className="w-4 h-4 text-msf-accent" />
                  <span className="text-white font-medium">Session {session.id}</span>
                </div>
                <p className="text-sm text-gray-400 mt-1 truncate">
                  {session.info || session.session_host}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {session.platform} / {session.arch}
                </p>
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Main Content */}
      {selectedSession && (
        <div className="bg-msf-card border border-msf-border rounded-lg overflow-hidden">
          {/* Tabs */}
          <div className="flex border-b border-msf-border overflow-x-auto">
            {tabs.map((tab) => {
              const Icon = tab.icon
              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex items-center gap-2 px-4 py-3 text-sm font-medium whitespace-nowrap transition-colors ${
                    activeTab === tab.id
                      ? 'text-msf-accent border-b-2 border-msf-accent bg-msf-darker'
                      : 'text-gray-400 hover:text-white'
                  }`}
                >
                  <Icon className="w-4 h-4" />
                  {tab.label}
                </button>
              )
            })}
          </div>

          {/* Tab Content */}
          <div className="p-4">
            {isLoading && (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="w-8 h-8 text-msf-accent animate-spin" />
              </div>
            )}

            {/* System Info Tab */}
            {activeTab === 'info' && !isLoading && (
              <div className="space-y-4">
                {/* Quick Actions */}
                <div className="flex flex-wrap gap-2">
                  <button onClick={handleGetSystem} className="btn btn-secondary btn-sm flex items-center gap-1">
                    <ArrowUp className="w-4 h-4" />
                    Get SYSTEM
                  </button>
                  <button onClick={handleHashdump} className="btn btn-secondary btn-sm flex items-center gap-1">
                    <Hash className="w-4 h-4" />
                    Hashdump
                  </button>
                  <button onClick={handleTakeScreenshot} className="btn btn-secondary btn-sm flex items-center gap-1">
                    <Camera className="w-4 h-4" />
                    Screenshot
                  </button>
                  <button onClick={handleSuggestExploits} className="btn btn-secondary btn-sm flex items-center gap-1">
                    <Crosshair className="w-4 h-4" />
                    Suggest Exploits
                  </button>
                  <button onClick={loadSystemInfo} className="btn btn-secondary btn-sm flex items-center gap-1">
                    <RefreshCw className="w-4 h-4" />
                    Refresh
                  </button>
                </div>

                {/* System Info Grid */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-msf-darker rounded-lg p-4">
                    <h4 className="text-sm font-medium text-white mb-3">System Information</h4>
                    {sysinfo ? (
                      <div className="space-y-2 text-sm">
                        {Object.entries(sysinfo).map(([key, value]) => (
                          <div key={key} className="flex justify-between">
                            <span className="text-gray-400 capitalize">{key.replace(/_/g, ' ')}</span>
                            <span className="text-white">{String(value)}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-400">Loading...</p>
                    )}
                  </div>

                  <div className="bg-msf-darker rounded-lg p-4">
                    <h4 className="text-sm font-medium text-white mb-3">Current User</h4>
                    <p className="text-lg text-msf-accent font-mono">{uid || 'Loading...'}</p>

                    <h4 className="text-sm font-medium text-white mt-4 mb-2">Privileges ({privs.length})</h4>
                    <div className="max-h-48 overflow-y-auto space-y-1">
                      {privs.map((priv, i) => (
                        <p key={i} className="text-xs text-gray-300 font-mono">{priv}</p>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Processes Tab */}
            {activeTab === 'processes' && !isLoading && (
              <div className="space-y-4">
                <div className="flex items-center gap-2">
                  <div className="flex-1 relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                    <input
                      type="text"
                      value={processSearch}
                      onChange={(e) => setProcessSearch(e.target.value)}
                      placeholder="Search processes..."
                      className="input pl-10 w-full"
                    />
                  </div>
                  <button onClick={loadProcesses} className="btn btn-secondary">
                    <RefreshCw className="w-4 h-4" />
                  </button>
                </div>

                <div className="max-h-[500px] overflow-y-auto">
                  <table className="w-full">
                    <thead className="bg-msf-darker sticky top-0">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">PID</th>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">Name</th>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">User</th>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">Arch</th>
                        <th className="px-3 py-2 text-right text-xs text-gray-400">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredProcesses.map((proc) => (
                        <tr key={proc.pid} className="border-t border-msf-border hover:bg-msf-darker/50">
                          <td className="px-3 py-2 text-sm text-white font-mono">{proc.pid}</td>
                          <td className="px-3 py-2 text-sm text-white">{proc.name}</td>
                          <td className="px-3 py-2 text-sm text-gray-400">{proc.user}</td>
                          <td className="px-3 py-2 text-sm text-gray-400">{proc.arch}</td>
                          <td className="px-3 py-2 text-right">
                            <div className="flex items-center justify-end gap-1">
                              <button
                                onClick={() => handleMigrate(proc.pid)}
                                className="p-1 text-gray-400 hover:text-msf-blue"
                                title="Migrate to this process"
                              >
                                <ArrowUp className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleKillProcess(proc.pid)}
                                className="p-1 text-gray-400 hover:text-msf-red"
                                title="Kill process"
                              >
                                <X className="w-4 h-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Files Tab */}
            {activeTab === 'files' && !isLoading && (
              <div className="space-y-4">
                <div className="flex items-center gap-2">
                  <button
                    onClick={handleGoBack}
                    disabled={pathHistory.length === 0}
                    className="btn btn-secondary btn-sm"
                  >
                    <ChevronRight className="w-4 h-4 rotate-180" />
                  </button>
                  <div className="flex-1 bg-msf-darker rounded px-3 py-2">
                    <span className="text-sm text-white font-mono">{currentPath}</span>
                  </div>
                  <button onClick={() => loadFiles(currentPath)} className="btn btn-secondary btn-sm">
                    <RefreshCw className="w-4 h-4" />
                  </button>
                </div>

                <div className="max-h-[500px] overflow-y-auto">
                  <table className="w-full">
                    <thead className="bg-msf-darker sticky top-0">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">Name</th>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">Size</th>
                        <th className="px-3 py-2 text-left text-xs text-gray-400">Modified</th>
                        <th className="px-3 py-2 text-right text-xs text-gray-400">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {files.map((file, i) => (
                        <tr
                          key={i}
                          className="border-t border-msf-border hover:bg-msf-darker/50 cursor-pointer"
                          onDoubleClick={() => handleNavigate(file.name, file.type === 'directory')}
                        >
                          <td className="px-3 py-2">
                            <div className="flex items-center gap-2">
                              {file.type === 'directory' ? (
                                <Folder className="w-4 h-4 text-msf-blue" />
                              ) : (
                                <File className="w-4 h-4 text-gray-400" />
                              )}
                              <span className="text-sm text-white">{file.name}</span>
                            </div>
                          </td>
                          <td className="px-3 py-2 text-sm text-gray-400">
                            {file.type === 'directory' ? '-' : `${file.size} B`}
                          </td>
                          <td className="px-3 py-2 text-sm text-gray-400">{file.modified}</td>
                          <td className="px-3 py-2 text-right">
                            {file.type === 'file' && (
                              <button
                                onClick={() => handleDownloadFile(file.name)}
                                className="p-1 text-gray-400 hover:text-msf-blue"
                                title="Download"
                              >
                                <Download className="w-4 h-4" />
                              </button>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Credentials Tab */}
            {activeTab === 'credentials' && !isLoading && (
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <button onClick={loadCredentials} className="btn btn-secondary btn-sm">
                      <RefreshCw className="w-4 h-4" />
                    </button>
                    {selectedSession && (
                      <button onClick={handleHashdump} className="btn btn-secondary btn-sm flex items-center gap-1">
                        <Hash className="w-4 h-4" />
                        Run Hashdump
                      </button>
                    )}
                  </div>
                  <button
                    onClick={() => setShowAddCred(true)}
                    className="btn btn-primary btn-sm flex items-center gap-1"
                  >
                    <Plus className="w-4 h-4" />
                    Add Credential
                  </button>
                </div>

                {credentials.length === 0 ? (
                  <div className="text-center py-8 text-gray-400">
                    <Key className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p>No credentials stored</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {credentials.map((cred) => (
                      <div
                        key={cred.id}
                        className="bg-msf-darker rounded-lg p-3 border border-msf-border"
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="text-white font-medium">{cred.username}</span>
                              {cred.domain && (
                                <span className="text-xs text-gray-400">@{cred.domain}</span>
                              )}
                              {cred.source && (
                                <span className="text-xs px-2 py-0.5 bg-msf-blue/20 text-msf-blue rounded">
                                  {cred.source}
                                </span>
                              )}
                            </div>
                            <div className="mt-1 space-y-1 text-sm">
                              {cred.password && (
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-400">Password:</span>
                                  <span className="font-mono text-green-400">{cred.password}</span>
                                  <button
                                    onClick={() => copyToClipboard(cred.password!)}
                                    className="text-gray-400 hover:text-white"
                                  >
                                    <Copy className="w-3 h-3" />
                                  </button>
                                </div>
                              )}
                              {cred.hash && (
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-400">Hash ({cred.hash_type || 'unknown'}):</span>
                                  <span className="font-mono text-yellow-400 truncate max-w-xs">{cred.hash}</span>
                                  <button
                                    onClick={() => copyToClipboard(cred.hash!)}
                                    className="text-gray-400 hover:text-white"
                                  >
                                    <Copy className="w-3 h-3" />
                                  </button>
                                </div>
                              )}
                              {cred.host && (
                                <div className="flex items-center gap-2">
                                  <span className="text-gray-400">Host:</span>
                                  <span className="text-gray-300">{cred.host}</span>
                                  {cred.service && <span className="text-gray-500">({cred.service})</span>}
                                </div>
                              )}
                            </div>
                          </div>
                          <button
                            onClick={() => handleDeleteCredential(cred.id)}
                            className="p-1 text-gray-400 hover:text-msf-red"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Add Credential Modal */}
                {showAddCred && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-msf-card border border-msf-border rounded-lg w-full max-w-md">
                      <div className="flex items-center justify-between p-4 border-b border-msf-border">
                        <h2 className="text-lg font-semibold text-white">Add Credential</h2>
                        <button onClick={() => setShowAddCred(false)} className="text-gray-400 hover:text-white">
                          <X className="w-5 h-5" />
                        </button>
                      </div>
                      <form onSubmit={handleAddCredential} className="p-4 space-y-4">
                        <div>
                          <label className="block text-sm text-gray-300 mb-1">Username *</label>
                          <input
                            type="text"
                            value={credForm.username}
                            onChange={(e) => setCredForm({ ...credForm, username: e.target.value })}
                            className="input w-full"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm text-gray-300 mb-1">Password</label>
                          <input
                            type="text"
                            value={credForm.password}
                            onChange={(e) => setCredForm({ ...credForm, password: e.target.value })}
                            className="input w-full"
                          />
                        </div>
                        <div>
                          <label className="block text-sm text-gray-300 mb-1">Hash</label>
                          <input
                            type="text"
                            value={credForm.hash}
                            onChange={(e) => setCredForm({ ...credForm, hash: e.target.value })}
                            className="input w-full font-mono"
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm text-gray-300 mb-1">Host</label>
                            <input
                              type="text"
                              value={credForm.host}
                              onChange={(e) => setCredForm({ ...credForm, host: e.target.value })}
                              className="input w-full"
                            />
                          </div>
                          <div>
                            <label className="block text-sm text-gray-300 mb-1">Service</label>
                            <input
                              type="text"
                              value={credForm.service}
                              onChange={(e) => setCredForm({ ...credForm, service: e.target.value })}
                              className="input w-full"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm text-gray-300 mb-1">Notes</label>
                          <textarea
                            value={credForm.notes}
                            onChange={(e) => setCredForm({ ...credForm, notes: e.target.value })}
                            className="input w-full h-20 resize-none"
                          />
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t border-msf-border">
                          <button type="button" onClick={() => setShowAddCred(false)} className="btn btn-secondary">
                            Cancel
                          </button>
                          <button type="submit" className="btn btn-primary">
                            Add Credential
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Modules Tab */}
            {activeTab === 'modules' && !isLoading && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {/* Module List */}
                <div className="space-y-3">
                  <div className="flex items-center gap-2">
                    <div className="flex-1 relative">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                      <input
                        type="text"
                        value={moduleSearch}
                        onChange={(e) => setModuleSearch(e.target.value)}
                        placeholder="Search modules..."
                        className="input pl-10 w-full"
                      />
                    </div>
                    <select
                      value={modulePlatform}
                      onChange={(e) => setModulePlatform(e.target.value)}
                      className="input w-32"
                    >
                      <option value="">All</option>
                      {platforms.map((p) => (
                        <option key={p} value={p}>{p}</option>
                      ))}
                    </select>
                  </div>

                  <div className="max-h-[400px] overflow-y-auto space-y-1">
                    {postModules.slice(0, 100).map((mod) => (
                      <button
                        key={mod.name}
                        onClick={() => handleLoadModuleInfo(mod)}
                        className={`w-full text-left px-3 py-2 rounded text-sm transition-colors ${
                          selectedModule?.name === mod.fullname
                            ? 'bg-msf-accent/20 text-msf-accent'
                            : 'hover:bg-msf-darker text-gray-300'
                        }`}
                      >
                        <span className="font-mono text-xs">{mod.name}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Module Details */}
                <div className="bg-msf-darker rounded-lg p-4">
                  {selectedModule ? (
                    <div className="space-y-4">
                      <div>
                        <h3 className="text-lg font-medium text-white">{selectedModule.name}</h3>
                        <p className="text-sm text-gray-400 mt-1">{selectedModule.description}</p>
                      </div>

                      <div>
                        <h4 className="text-sm font-medium text-white mb-2">Options</h4>
                        <div className="space-y-2 max-h-48 overflow-y-auto">
                          {selectedModule.options && Object.entries(selectedModule.options)
                            .filter(([, opt]) => !opt.advanced)
                            .map(([name, opt]) => (
                              <div key={name}>
                                <label className="block text-xs text-gray-400 mb-1">
                                  {name} {opt.required && <span className="text-msf-red">*</span>}
                                </label>
                                <input
                                  type="text"
                                  value={moduleOptions[name] || ''}
                                  onChange={(e) => setModuleOptions({ ...moduleOptions, [name]: e.target.value })}
                                  placeholder={opt.description}
                                  className="input w-full text-sm"
                                />
                              </div>
                            ))}
                        </div>
                      </div>

                      <button
                        onClick={handleRunModule}
                        disabled={!selectedSession}
                        className="btn btn-primary w-full flex items-center justify-center gap-2"
                      >
                        <Play className="w-4 h-4" />
                        Run Module
                      </button>

                      {!selectedSession && (
                        <p className="text-xs text-yellow-400 text-center">
                          <AlertTriangle className="w-3 h-3 inline mr-1" />
                          Select a session to run this module
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-gray-400">
                      <Terminal className="w-12 h-12 mx-auto mb-2 opacity-50" />
                      <p>Select a module to view details</p>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  )
}
